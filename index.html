<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TESA ‚Äî Tech Spec Assistant (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0a0d12;
      --panel:#0f1420;
      --panel2:#0c111a;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --muted2:rgba(255,255,255,.40);
      --accent:#a56bff;
      --accent2:#7c4dff;
      --warn:#ffcc66;
      --ok:#27e49f;
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(165,107,255,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(39,228,159,.15), transparent 60%),
        radial-gradient(700px 500px at 60% 90%, rgba(124,77,255,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }

    .shell{
      width:min(980px, 100%);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 70%),
        linear-gradient(135deg, rgba(165,107,255,1), rgba(124,77,255,1));
      box-shadow: 0 10px 26px rgba(124,77,255,.24);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      letter-spacing:.5px;
    }
    .brand h1{
      font-size:18px;
      margin:0;
      line-height:1.15;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .meta{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(15,20,32,.60);
      backdrop-filter: blur(10px);
      min-width: 240px;
    }
    .meta strong{color:var(--text); font-weight:700;}

    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:rgba(15,20,32,.72);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }

    .topbar{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(39,228,159,.9);
      box-shadow: 0 0 0 4px rgba(39,228,159,.12);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,17,26,.95);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition: .14s transform, .14s background, .14s border-color, .14s opacity;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18);}
    button:active{transform: translateY(0px); opacity:.95;}
    button.primary{
      background: linear-gradient(135deg, rgba(165,107,255,.95), rgba(124,77,255,.95));
      border-color: rgba(255,255,255,.15);
      box-shadow: 0 12px 28px rgba(124,77,255,.20);
    }
    button.ghost{
      background:rgba(12,17,26,.60);
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .content{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .inputRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input[type="text"]{
      flex:1;
      min-width:240px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(12,17,26,.92);
      color:var(--text);
      padding:12px 14px;
      font-size:14px;
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(255,255,255,.35)}
    input[type="text"]:focus{border-color: rgba(165,107,255,.45); box-shadow: 0 0 0 4px rgba(165,107,255,.12);}

    .status{
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(12,17,26,.45);
    }

    .result{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background:rgba(12,17,26,.70);
      padding:16px;
    }

    .resultHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .partName{
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0 0 2px 0;
    }
    .subName{
      font-size:12px;
      color:var(--muted);
      margin:0;
    }

    .torqueDisplay{
      margin-top:12px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,20,32,.55);
    }

    .torqueBig{
      font-size:34px;
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:baseline;
      gap:8px;
    }
    .torqueUnit{
      font-size:14px;
      font-weight:800;
      opacity:.85;
    }

    .chemLine{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,17,26,.55);
      color:rgba(255,255,255,.85);
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chemBadge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      color:rgba(255,255,255,.90);
    }
    .chemKey{color:rgba(255,255,255,.6); font-weight:700; margin-right:6px}
    .chemVal{font-weight:800; color:rgba(255,255,255,.92)}

    .infoBlock{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,20,32,.38);
      font-size:13px;
      color:rgba(255,255,255,.82);
      line-height:1.45;
    }
    .infoTitle{
      font-size:12px;
      color:rgba(255,255,255,.60);
      font-weight:800;
      letter-spacing:.3px;
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .infoLine{
      margin:6px 0;
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .infoKey{
      min-width:86px;
      font-weight:800;
      color:rgba(255,255,255,.70);
    }

    .refBlock{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,17,26,.55);
    }
    .refRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .refLabel{
      font-size:12px;
      font-weight:900;
      color:rgba(255,255,255,.72);
      letter-spacing:.2px;
    }
    .refItemNum{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:rgba(255,255,255,.90);
      font-weight:800;
    }
    .refImages{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .refImages img{
      width:100%;
      max-width: 520px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
    }

    .pills{
      margin-top:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      color:rgba(255,255,255,.84);
    }

    .askMore{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .askMore .q{
      font-size:12px;
      color:rgba(255,255,255,.70);
      font-weight:800;
    }

    .foot{
      padding:10px 16px;
      border-top:1px solid var(--line);
      font-size:12px;
      color:var(--muted2);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }
    a{color:rgba(165,107,255,.95); text-decoration:none}
    a:hover{text-decoration:underline}

    /* Multi-step / multi-size rows */
    .stepsBox{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,20,32,.55);
    }
    .stepsTitle{
      font-size:12px;
      color:rgba(255,255,255,.60);
      font-weight:900;
      letter-spacing:.3px;
      margin-bottom:10px;
      text-transform:uppercase;
    }
    .stepRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .stepRow:last-child{border-bottom:none}
    .stepLabel{
      font-size:12px;
      font-weight:900;
      color:rgba(255,255,255,.70);
      letter-spacing:.2px;
      text-transform:uppercase;
      white-space:nowrap;
      padding-right:12px;
      flex:0 0 auto;
    }
    .stepValue{
      flex:1 1 auto;
      text-align:right;
      white-space:nowrap;
    }
    .stepNum{
      font-size:28px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .stepUnit{
      font-size:13px;
      font-weight:900;
      opacity:.85;
      margin-left:8px;
    }
    .stepPlus{font-size:13px; opacity:.9; margin:0 6px;}

    @media (max-width: 720px){
      .meta{min-width: 0}
      .torqueBig{font-size:32px}
      .stepNum{font-size:26px}
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h1>TESA</h1>
          <div class="sub">Tech Spec Assistant ‚Äî MVP</div>
        </div>
      </div>
      <div class="meta" id="metaBadge">
        <strong>Loading model...</strong><br/>
        Please wait
      </div>
    </header>

    <div class="panel">
      <div class="topbar">
        <div class="hint">
          <div class="dot"></div>
          <span id="hintText">Tap the mic and ask a tightening torque (e.g., ‚Äúrear brake caliper‚Äù).</span>
        </div>
        <div class="controls">
          <button class="ghost" id="btnStop" disabled>‚èπ Stop</button>
          <button class="primary" id="btnMic">üéô Start</button>
        </div>
      </div>

      <div class="content">
        <div class="inputRow">
          <input id="q" type="text" placeholder="Type here (fallback) ‚Äî e.g., oil drain bolt" />
          <button class="ghost" id="btnSearch">üîé Search</button>
        </div>

        <div class="status" id="statusBox">Loading dataset...</div>

        <div class="result" id="resultBox" style="display:none;"></div>
        <div class="result" id="ambiguousBox" style="display:none;"></div>
      </div>

      <div class="foot">
        <div>Tip: On iPhone Safari, mic access may require a user tap.</div>
        <div>TESA MVP ‚Äî static demo (GitHub Pages)</div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const DATASET_FILE = "panigale_v2_torque_2020-2025_fin.json";

  // ====== STATE ======
  let TORQUE_DATA = [];
  let DATASET_META = { make:"", model:"", years:{from:"",to:""} };

  let recognition = null;
  let isListening = false;
  let isSpeaking = false;

  // ====== UI REFS ======
  const elStatus = document.getElementById("statusBox");
  const elResult = document.getElementById("resultBox");
  const elAmbig  = document.getElementById("ambiguousBox");
  const elMeta   = document.getElementById("metaBadge");
  const elBtnMic = document.getElementById("btnMic");
  const elBtnStop= document.getElementById("btnStop");
  const elBtnSearch = document.getElementById("btnSearch");
  const elQ = document.getElementById("q");
  const elHint = document.getElementById("hintText");

  // ====== HELPERS ======
  function setStatus(msg){
    elStatus.textContent = msg;
  }

  function getSignificantWords(query){
    const q = String(query || "").toLowerCase();
    const stop = new Set([
      "the","a","an","of","to","for","and","or","in","on","at","is","are","was","were",
      "bolt","bolts","nut","nuts","screw","screws","fastener","fasteners","torque",
      "tighten","tightening","spec","specs","value","what","whats","what's","please",
      "rear","front","left","right"
    ]);
    return q
      .replace(/[^\w\s-]/g, " ")
      .split(/\s+/)
      .map(s => s.trim())
      .filter(Boolean)
      .filter(w => !stop.has(w) && w.length >= 2);
  }

  async function loadTorqueData(){
    try{
      setStatus("Loading dataset...");
      const res = await fetch(DATASET_FILE, {cache:"no-store"});
      if (!res.ok) throw new Error(`Failed to load dataset: ${res.status}`);
      const data = await res.json();

      const { meta, items } = extractDatasetMeta(data);
      DATASET_META = meta;
      TORQUE_DATA = items;

      elMeta.innerHTML = `<strong>${escapeHtml(meta.make || "Unknown")} ${escapeHtml(meta.model || "")}</strong><br/>${escapeHtml(meta.years.from || "‚Äî")}‚Äì${escapeHtml(meta.years.to || "‚Äî")}`;
      setStatus(`Ready. Loaded ${TORQUE_DATA.length} fasteners.`);
    } catch (e){
      console.error(e);
      setStatus(`Error: ${e.message || e}`);
      elMeta.innerHTML = `<strong>Model</strong><br/>Not loaded`;
    }
  }

  function extractDatasetMeta(data){
    // Supports BOTH:
    //  (new) { dataset:{make,model,years:{from,to}}, items:[...] }
    //  (old) { manufacturer, model, year_start, year_end, torque_data:[...] }
    const meta = { make:"", model:"", years:{from:"",to:""} };
    let items = [];

    if (data && data.dataset && data.items){
      meta.make = data.dataset.make || data.dataset.manufacturer || "";
      meta.model = data.dataset.model || "";
      meta.years = data.dataset.years || {from:"",to:""};
      items = Array.isArray(data.items) ? data.items : [];
      return { meta, items };
    }

    // Old schema fallback
    if (data){
      meta.make = data.manufacturer || data.make || "";
      meta.model = data.model || "";
      meta.years = { from: data.year_start || "", to: data.year_end || "" };
      items = Array.isArray(data.torque_data) ? data.torque_data : (Array.isArray(data.items) ? data.items : []);
    }
    return { meta, items };
  }

  function splitList(val){
    if (val == null) return [];
    if (Array.isArray(val)) return val.map(x => String(x ?? "").trim()).filter(Boolean);
    const s = String(val).trim();
    if (!s) return [];
    return s.split(/[;,\n]/).map(x => x.trim()).filter(Boolean);
  }

  function parseTorqueStepsText(text){
    // Accept separators: newline or semicolon. Preserve user-entered content as much as possible.
    return String(text)
      .split(/\r?\n|;/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function getTorqueStepsRows(item){
    // Returns rows for UI in the form [{label, value}] for multi-step; [] otherwise.
    const tt = (item && item.tightening_type ? String(item.tightening_type).trim().toLowerCase() : "");
    if (tt !== "multi_step") return [];

    // If torque_steps is an array of objects (structured), keep existing behavior.
    if (Array.isArray(item.torque_steps) && item.torque_steps.length){
      return item.torque_steps.map((s, idx) => {
        const rawLabel = (s.step != null ? String(s.step) : String(idx + 1)).trim();
        const parts = [];
        if (s.torque_nm != null) parts.push(`${s.torque_nm} Nm`);
        if (s.angle_deg != null) parts.push(`+ ${s.angle_deg}¬∞`);
        const value = parts.length ? parts.join(" ") : (s.raw || "Follow manual");
        return { label: rawLabel, value };
      });
    }

    // If torque_steps is a string, parse "Step1: 25Nm; Step2: 30Nm; ..." OR "M8: 25Nm; M6: 10Nm; ..."
    if (item.torque_steps != null && String(item.torque_steps).trim()){
      const lines = parseTorqueStepsText(item.torque_steps);
      return lines.map((line, idx) => {
        // If the line already has a label (e.g., "Step 1: 5 Nm"), keep it.
        const parts = line.split(":");
        if (parts.length >= 2){
          const label = parts.shift().trim();
          const value = parts.join(":").trim();
          return { label: label || String(idx + 1), value: value || "Follow manual" };
        }
        return { label: String(idx + 1), value: line };
      });
    }

    return [];
  }

  function classifyTorqueStepsRows(rows){
    // Returns "multi_step" or "multi_size" (default multi_step)
    if (!Array.isArray(rows) || !rows.length) return "multi_step";
    const labels = rows.map(r => String(r?.label ?? "").trim());
    const allSize = labels.length > 0 && labels.every(l => /^m\d+$/i.test(l));
    if (allSize) return "multi_size";

    const allStep = labels.length > 0 && labels.every(l => /^step\s*\d+$/i.test(l) || /^step\d+$/i.test(l) || /^\d+$/.test(l));
    if (allStep) return "multi_step";

    // Mixed/unknown ‚Üí treat as multi_step (safer)
    return "multi_step";
  }

  function normalizeStepLabel(label){
    const s = String(label ?? "").trim();
    if (!s) return "";
    // Accept "1", "Step 1", "Step1"
    if (/^\d+$/.test(s)) return `STEP${s}`;
    const m = s.match(/step\s*(\d+)/i) || s.match(/step(\d+)/i);
    if (m) return `STEP${m[1]}`;
    return s.toUpperCase();
  }

  function normalizeSizeLabel(label){
    const s = String(label ?? "").trim();
    if (!s) return "";
    const m = s.match(/m\s*(\d+)/i);
    if (m) return `M${m[1]}`;
    return s.toUpperCase();
  }

  function extractNmNumber(text){
    // Returns string number (as entered) or null
    const s = String(text ?? "");
    // Look for a number that is followed by optional space and "Nm"
    const m = s.match(/(-?\d+(?:\.\d+)?)\s*nm\b/i);
    if (m) return m[1];
    // Fallback: first number if "Nm" not present but looks like "25" only
    const m2 = s.match(/(-?\d+(?:\.\d+)?)/);
    return m2 ? m2[1] : null;
}

function extractAngleNumber(text){
  const s = String(text ?? "");
  const m = s.match(/(-?\d+(?:\.\d+)?)\s*¬∞/);
  return m ? m[1] : null;
}

function formatTorqueValueHtml(valueText){
  const s = String(valueText ?? "");
  const nm = extractNmNumber(s);
  const deg = extractAngleNumber(s);

  // If both torque and angle are present (e.g., "35 Nm + 90¬∞"), show both.
  if (nm && deg){
    return `<span class="stepNum">${escapeHtml(nm)}</span><span class="stepUnit">Nm</span><span class="stepPlus"> + </span><span class="stepNum">${escapeHtml(deg)}</span><span class="stepUnit">¬∞</span>`;
  }

  // Angle-only step (e.g., "100¬∞")
  if (deg){
    return `<span class="stepNum">${escapeHtml(deg)}</span><span class="stepUnit">¬∞</span>`;
  }

  // Torque step (default)
  if (!nm) return escapeHtml(s);
  return `<span class="stepNum">${escapeHtml(nm)}</span><span class="stepUnit">Nm</span>`;
}

  function getTorqueStepsForSpeech(item){
  // Returns an array of objects compatible with the speech builder:
  // [{ step, torque_nm?, angle_deg?, raw? }]
  const tt = (item && item.tightening_type ? String(item.tightening_type).trim().toLowerCase() : "");
  if (tt !== "multi_step") return [];

  if (Array.isArray(item.torque_steps) && item.torque_steps.length){
    return item.torque_steps;
  }

  if (item.torque_steps != null && String(item.torque_steps).trim()){
    const lines = parseTorqueStepsText(item.torque_steps);

    return lines.map((line, idx) => {
      // Try to preserve explicit labels like "Step3" or "M8"
      let label = String(idx + 1);
      let value = String(line ?? "").trim();

      const parts = value.split(":");
      if (parts.length >= 2){
        label = parts.shift().trim() || label;
        value = parts.join(":").trim();
      }

      // Extract torque and/or angle from the value text.
      const nmMatch = value.match(/(-?\d+(?:\.\d+)?)\s*nm\b/i);
      const degMatch = value.match(/(-?\d+(?:\.\d+)?)\s*¬∞/);

      const out = { step: label || String(idx + 1) };
      if (nmMatch) out.torque_nm = nmMatch[1];
      if (degMatch) out.angle_deg = degMatch[1];

      if (!nmMatch && !degMatch){
        // Keep original when we can't parse.
        out.raw = String(line ?? "").trim();
      }
      return out;
    });
  }

  return [];
}

  function getExtraNotesList(item){
    // extra_notes is TEXT field (string) per spec, but tolerate arrays too.
    const v = item ? item.extra_notes : null;
    return splitList(v);
  }

  function getSpecialTools(item){
    // Return array of strings (safe)
    const nums = splitList(item?.special_tool_numbers);
    const names = splitList(item?.special_tool_name);
    const out = [];
    nums.forEach(n => out.push(n));
    names.forEach(n => out.push(n));
    return out.filter(Boolean);
  }

  function scoreItem(item, sigWords){
    // Higher score = better match.
    const a = String(item.component_name || "").toLowerCase();
    const b = String(item.common_name || "").toLowerCase();
    let score = 0;

    // Exact substring boosts
    const q = sigWords.join(" ");
    if (q && (a.includes(q) || b.includes(q))) score += 20;

    sigWords.forEach(w => {
      if (a.includes(w)) score += 8;
      if (b.includes(w)) score += 6;
    });

    // penalty: too short names and weak match
    if (score === 0 && (a.length < 6 && b.length < 6)) score -= 2;

    return score;
  }

  function findCandidates(query){
    const sig = getSignificantWords(query);
    if (!sig.length) return [];
    const scored = TORQUE_DATA
      .map(item => ({ item, score: scoreItem(item, sig) }))
      .filter(x => x.score > 0)
      .sort((x,y) => y.score - x.score);

    // Keep top 6
    return scored.slice(0, 6);
  }

  function renderEmpty(msg){
    elResult.style.display = "none";
    elAmbig.style.display = "none";
    setStatus(msg || "No result.");
  }

  function setRepeatStop(canStop){
    elBtnStop.disabled = !canStop;
  }

  function stopSpeak(){
    try{
      window.speechSynthesis.cancel();
      isSpeaking = false;
      setRepeatStop(false);
    }catch(e){}
  }

  function speak(text, onend){
    stopSpeak();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.02;
    u.pitch = 1.0;
    u.onend = () => { isSpeaking = false; setRepeatStop(false); onend && onend(); };
    u.onerror = () => { isSpeaking = false; setRepeatStop(false); onend && onend(); };
    isSpeaking = true;
    setRepeatStop(true);
    window.speechSynthesis.speak(u);
  }

  function speakNumbersDigitByDigit(text){
    // Used for torque like "25 Nm" if desired ‚Äî currently not used for all flows.
    // Keep as placeholder for future.
    speak(text);
  }

  function buildSpokenAnswerParts(item){
    if (!item) return { base:"No matching fastener found.", info:"" };

    const name = item.component_name || "this fastener";
    const stepsForSpeech = getTorqueStepsForSpeech(item);
    const hasSteps = stepsForSpeech.length > 0;

    // Detect bolt-size variants: ALL step labels are like M8, M6, M10...
    let isBoltSizeVariant = false;
    if (hasSteps){
      const labels = stepsForSpeech.map((s, idx) => {
        const raw = (s.step != null ? String(s.step) : String(idx + 1)).trim();
        return raw;
      });
      isBoltSizeVariant = labels.length > 0 && labels.every(l => /^m\d+$/i.test(l));
    }

    const baseParts = [];
    const infoParts = [];

    // partName: speak name only
    baseParts.push(`${name}.`);

    // ---- Torque / steps ----
    const tt = (item && item.tightening_type ? String(item.tightening_type).trim().toLowerCase() : "");
    if (tt === "single" && item.torque_nm_single != null && String(item.torque_nm_single).trim()){
      baseParts.push(`${String(item.torque_nm_single).trim()} newton meters.`);
    } else if (hasSteps && isBoltSizeVariant){
      baseParts.push(`Torque by size.`);
      stepsForSpeech.forEach((s, idx) => {
        const size = (s.step != null ? String(s.step) : String(idx + 1)).trim().toUpperCase();
        const seg = [];
        if (s.torque_nm != null) seg.push(`${s.torque_nm} newton meters`);
        if (s.angle_deg != null) seg.push(`plus ${s.angle_deg} degrees`);
        if (seg.length) baseParts.push(`${size}: ${seg.join(", ")}.`);
        else if (s.raw) baseParts.push(`${size}: ${s.raw}.`);
      });
    } else if (hasSteps){
      // baseParts.push(`Tightening procedure.`); // removed per spec
      stepsForSpeech.forEach((step, idx) => {
        let label = (step.step != null ? String(step.step) : String(idx + 1)).trim();
        if (/^\d+$/.test(label)) label = `Step ${label}`;
        else if (/^step\s*\d+$/i.test(label)){
          const m = label.match(/(\d+)/);
          if (m) label = `Step ${m[1]}`;
        } else if (/^step\d+$/i.test(label)){
          const m = label.match(/(\d+)/);
          if (m) label = `Step ${m[1]}`;
        }
        if (step.torque_nm != null && step.angle_deg != null){
          baseParts.push(`${label}. ${step.torque_nm} newton meters, then add ${step.angle_deg} degrees.`);
        } else if (step.torque_nm != null){
          baseParts.push(`${label}. ${step.torque_nm} newton meters.`);
        } else if (step.angle_deg != null){
          baseParts.push(`${label}. Add ${step.angle_deg} degrees.`);
        } else if (step.raw){
          baseParts.push(`${label}. ${step.raw}.`);
        }
      });
    } else if (tt === "single" && item.torque != null && String(item.torque).trim()){
      // backward compat
      baseParts.push(`${String(item.torque).trim()} newton meters.`);
    } else {
      baseParts.push(`Torque value not found.`);
    }

    // ---- Chemistry line ----
    const chemParts = [];
    if (item.threadlock) chemParts.push(`Threadlock ${item.threadlock}`);
    if (item.lubrication_symbol) chemParts.push(`Lube ${item.lubrication_symbol}`);
    if (item.sealant_symbol) chemParts.push(`Sealant ${item.sealant_symbol}`);
    if (chemParts.length) baseParts.push(chemParts.join(". ") + ".");

    // ---- Info gate content ----
    const extraNotes = getExtraNotesList(item);
    const specialTools = getSpecialTools(item);

    if (specialTools.length){
      infoParts.push(`Special tools: ${specialTools.join(", ")}.`);
    }
    extraNotes.forEach(n => {
      infoParts.push(`Note: ${n}.`);
    });

    // Also include infoBlock if present
    if (item.infoBlock != null && String(item.infoBlock).trim()){
      infoParts.push(String(item.infoBlock).trim());
    }

    return { base: baseParts.join(" "), info: infoParts.join(" ") };
  }

  function renderResult(item, info){
    const name = item.component_name || "Unknown fastener";

    // ----- Chemistry line (threadlock / lube / sealant) -----
    const chemItems = [];
    if (item.threadlock)  chemItems.push({k:"Threadlock", v:item.threadlock});

    // ‚úÖ show symbol instead of full lubrication text
    const lubeDisplay = item.lubrication_symbol || item.lubrication;
    if (lubeDisplay) chemItems.push({k:"Lube", v:lubeDisplay});

    const sealDisplay = item.sealant_symbol || item.sealant;
    if (sealDisplay) chemItems.push({k:"Sealant", v:sealDisplay});

    // ----- Torque (single vs multi) -----
    const tt = (item && item.tightening_type ? String(item.tightening_type).trim().toLowerCase() : "");

    let torqueHtml = "";
    let stepsHtml = "";

    if (tt === "single"){
      const torqueNm = item.torque_nm_single != null ? String(item.torque_nm_single).trim() : "";
      torqueHtml = torqueNm
        ? `<div class="torqueDisplay"><div class="torqueBig">${escapeHtml(torqueNm)} <span class="torqueUnit">Nm</span></div></div>`
        : `<div class="torqueDisplay"><div class="torqueBig">‚Äî <span class="torqueUnit">Nm</span></div></div>`;
    } else if (tt === "multi_step"){
      const rows = getTorqueStepsRows(item);
      const mode = classifyTorqueStepsRows(rows);

      if (rows.length){
        const title = (mode === "multi_size") ? "Torque by size" : "Tightening steps";
        const rowsHtml = rows.map(r => {
          const label = (mode === "multi_size") ? normalizeSizeLabel(r.label) : normalizeStepLabel(r.label);
          const valueHtml = formatTorqueValueHtml(r.value);
          return `<div class="stepRow"><div class="stepLabel">${escapeHtml(label)}</div><div class="stepValue">${valueHtml}</div></div>`;
        }).join("");

        stepsHtml = `<div class="stepsBox"><div class="stepsTitle">${escapeHtml(title)}</div>${rowsHtml}</div>`;
      } else {
        stepsHtml = `<div class="stepsBox"><div class="stepsTitle">Tightening steps</div><div style="color:rgba(255,255,255,.65);font-size:13px;">No step data.</div></div>`;
      }
    }

    // ----- InfoBlock always on screen (read gating handled separately) -----
    const infoBlockText = (item.infoBlock != null && String(item.infoBlock).trim()) ? String(item.infoBlock).trim() : "";

    // ----- Reference block (item_number + ref_images) -----
    const itemNum = (item.item_number != null && String(item.item_number).trim()) ? String(item.item_number).trim() : "";
    const refImages = Array.isArray(item.ref_images) ? item.ref_images : splitList(item.ref_image);

    let refBlockHtml = "";
    if (itemNum || (refImages && refImages.length)){
      const imgsHtml = (refImages && refImages.length)
        ? `<div class="refImages">${refImages.map(fn => `<img src="images/${encodeURIComponent(String(fn).trim())}" alt="reference image" loading="eager" />`).join("")}</div>`
        : "";
      const itemNumHtml = itemNum ? `<span class="refItemNum">Item: ${escapeHtml(itemNum)}</span>` : "";
      refBlockHtml = `
        <div class="refBlock">
          <div class="refRow">
            <div class="refLabel">Reference</div>
            ${itemNumHtml}
          </div>
          ${imgsHtml}
        </div>
      `;
    }

    // ----- Pills (meta pills) -----
    const pills = [];
    if (item.group) pills.push(String(item.group));
    if (item.score_type) pills.push(String(item.score_type));
    if (item.type) pills.push(String(item.type));

    let pillsHtml = "";
    if (pills.length){
      pillsHtml = `<div class="pills">${pills.map(p=>`<span class="pill">${escapeHtml(p)}</span>`).join("")}</div>`;
    }

    // ----- Extra Notes (shown in infoBlock) -----
    const extraNotes = getExtraNotesList(item);

    // ----- Special tools lines for infoBlock (screen always) -----
    const specialTools = getSpecialTools(item);

    let infoLines = "";
    specialTools.forEach(st => {
      infoLines += `<div class="infoLine"><span class="infoKey">Tool:</span> ${escapeHtml(st)}</div>`;
    });
    extraNotes.forEach(n => {
      infoLines += `<div class="infoLine"><span class="infoKey">Note:</span> ${escapeHtml(n)}</div>`;
    });
    if (infoBlockText){
      infoLines += `<div class="infoLine"><span class="infoKey">Info:</span> ${escapeHtml(infoBlockText)}</div>`;
    }

    const html = `
      <div class="resultHeader">
        <div>
          <div class="partName">${escapeHtml(name)}</div>
          <div class="subName">${escapeHtml(item.common_name || "")}</div>
        </div>
      </div>

      ${torqueHtml}
      ${stepsHtml}

      ${chemItems.length ? `
        <div class="chemLine">
          ${chemItems.map(c => `<span class="chemBadge"><span class="chemKey">${escapeHtml(c.k)}:</span><span class="chemVal">${escapeHtml(c.v)}</span></span>`).join("")}
        </div>
      ` : ""}

      <div class="infoBlock">
        <div class="infoTitle">Info block (shown on screen)</div>
        ${infoLines || `<div style="color:rgba(255,255,255,.60)">No additional info.</div>`}
      </div>

      ${refBlockHtml}

      ${pillsHtml}

      ${info && info.hasInfoToRead ? `
        <div class="askMore">
          <div class="q">Read additional info?</div>
          <button class="primary" id="btnYes">Yes</button>
          <button class="ghost" id="btnNo">No</button>
        </div>
      ` : ""}
    `;

    elAmbig.style.display = "none";
    elResult.style.display = "block";
    elResult.innerHTML = html;

    // Attach Yes/No if present
    const btnYes = document.getElementById("btnYes");
    const btnNo = document.getElementById("btnNo");
    if (btnYes && btnNo){
      btnYes.onclick = () => {
        const parts = buildSpokenAnswerParts(item);
        // Speak base first, then info
        speak(parts.base, () => {
          if (parts.info) speak(parts.info);
        });
      };
      btnNo.onclick = () => {
        const parts = buildSpokenAnswerParts(item);
        speak(parts.base);
      };
    } else {
      // No extra info gate: speak base automatically
      const parts = buildSpokenAnswerParts(item);
      speak(parts.base);
    }
  }

  function renderAmbiguous(cands){
    elResult.style.display = "none";
    elAmbig.style.display = "block";

    const rows = cands.map((c, idx) => {
      const it = c.item;
      const title = it.component_name || it.common_name || `Candidate ${idx+1}`;
      return `
        <div class="stepRow" style="border-bottom:1px solid rgba(255,255,255,.08); padding:10px 0;">
          <div style="flex:1; text-align:left;">
            <div style="font-weight:900; font-size:13px;">${escapeHtml(title)}</div>
            <div style="color:rgba(255,255,255,.60); font-size:12px;">${escapeHtml(it.common_name || "")}</div>
          </div>
          <button class="primary" data-idx="${idx}">Select</button>
        </div>
      `;
    }).join("");

    elAmbig.innerHTML = `
      <div style="font-weight:900; font-size:13px; margin-bottom:8px;">Multiple matches</div>
      <div style="color:rgba(255,255,255,.62); font-size:12px; margin-bottom:10px;">Select the correct fastener:</div>
      <div>${rows}</div>
    `;

    [...elAmbig.querySelectorAll("button[data-idx]")].forEach(btn => {
      btn.onclick = () => {
        const idx = Number(btn.getAttribute("data-idx"));
        const chosen = cands[idx]?.item;
        if (!chosen) return;
        const info = {
          hasInfoBlock: true,
          hasInfoToRead: !!(getSpecialTools(chosen).length || getExtraNotesList(chosen).length || (chosen.infoBlock && String(chosen.infoBlock).trim()))
        };
        renderResult(chosen, info);
      };
    });
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function normalizeQuery(q){
    return String(q || "").trim();
  }

  function handleQuery(query){
    const q = normalizeQuery(query);
    if (!q){
      renderEmpty("Type a part name or ask by voice.");
      return;
    }

    const cands = findCandidates(q);
    if (!cands.length){
      renderEmpty("No match found.");
      speak("No matching fastener found.");
      return;
    }

    if (cands.length === 1){
      const item = cands[0].item;
      const info = {
        hasInfoBlock: true,
        hasInfoToRead: !!(getSpecialTools(item).length || getExtraNotesList(item).length || (item.infoBlock && String(item.infoBlock).trim()))
      };
      renderResult(item, info);
      return;
    }

    renderAmbiguous(cands);
    speak("I found multiple matches. Please select the correct fastener.");
  }

  function initSpeech(){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition){
      elHint.textContent = "Voice input not supported in this browser. Use the text box.";
      elBtnMic.disabled = true;
      return;
    }
    recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      elBtnMic.textContent = "üéô Listening...";
      elBtnMic.disabled = true;
      setStatus("Listening...");
    };

    recognition.onend = () => {
      isListening = false;
      elBtnMic.textContent = "üéô Start";
      elBtnMic.disabled = false;
      setStatus("Ready.");
    };

    recognition.onerror = (e) => {
      console.error("Speech error:", e);
      setStatus("Speech error. Try typing instead.");
    };

    recognition.onresult = (event) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      elQ.value = text;
      handleQuery(text);
    };
  }

  // ====== EVENTS ======
  elBtnMic.addEventListener("click", () => {
    if (!recognition) return;
    try{
      recognition.start();
    } catch(e){
      // Sometimes start() throws if called twice quickly.
      console.warn(e);
    }
  });

  elBtnStop.addEventListener("click", () => {
    stopSpeak();
  });

  elBtnSearch.addEventListener("click", () => {
    handleQuery(elQ.value);
  });

  elQ.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      handleQuery(elQ.value);
    }
  });

  // ====== INIT ======
  (async function(){
    await loadTorqueData();
    initSpeech();
    renderEmpty("Ready. Ask a tightening torque.");
  })();
</script>
</body>
</html>
